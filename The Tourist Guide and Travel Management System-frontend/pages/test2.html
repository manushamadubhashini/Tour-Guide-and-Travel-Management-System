<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tour Booking - Dynamic Details</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="../css/style.css" rel="stylesheet">

  <!-- Icon Font Stylesheet -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Google Web Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">

  <style>

    /* Add these styles to your existing style section */

    .gallery-thumbnail:hover {
      opacity: 0.8;
      transform: scale(1.02);
      transition: all 0.3s ease;
    }

    .thumbnail-row::-webkit-scrollbar {
      height: 5px;
    }

    .thumbnail-row::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .thumbnail-row::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }

    .thumbnail-row::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    #mainGalleryImage {
      transition: all 0.3s ease;
    }

    .carousel-thumbnail {
      transition: all 0.2s ease;
      border: 3px solid transparent;
    }

    .carousel-thumbnail:hover {
      border-color: var(--primary-color);
    }

    /* Update the photo-count-badge position to match your screenshot */
    .photo-count-badge {
      position: absolute;
      bottom: 15px;
      left: 15px; /* Changed from right to left */
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Add more spacing between gallery and details */
    #tourGalleryContainer {
      animation: fadeIn 1.2s ease-out;
      margin-bottom: 30px;
    }

    /* Style the "Show all photos" button to match your design */
    #viewAllPhotos {
      border: 1px solid #333;
      border-radius: 5px;
      padding: 8px 16px;
      transition: all 0.3s ease;
    }

    #viewAllPhotos:hover {
      background-color: #333;
      color: white;
    }

    /* Animation for gallery */
    #tourGalleryContainer {
      animation: fadeIn 1.2s ease-out;
    }

    .gallery-thumbnail, #mainGalleryImage {
      animation: slideInFromBottom 1s ease-out;
    }

    @keyframes slideInFromBottom {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    :root {
      --primary-color: #ff9800;
      --text-color: #333;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      /*font-family: "JetBrains Mono ExtraLight";*/
      /*background-color: #f4f4f4;*/
      /*color: var(--text-color);*/
      /*overflow-x: hidden;*/
      animation: pageLoad 1s ease-out;
    }

    @keyframes pageLoad {
      0% {
        opacity: 0;
        transform: scale(0.95);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes slideInFromLeft {
      0% {
        opacity: 0;
        transform: translateX(-50px);
      }
      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideInFromRight {
      0% {
        opacity: 0;
        transform: translateX(50px);
      }
      100% {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .gallery-thumbnail:hover {
      opacity: 0.8;
      transform: scale(1.02);
      transition: all 0.3s ease;
    }

    .photo-count-badge {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 5px;
    }


    .tour-image {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      animation: slideInFromLeft 1s ease-out;
    }

    .booking-card {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      padding: 25px;
      animation: slideInFromRight 1s ease-out;
      position: sticky;
      top: 100px; /* Adjust this value to control when the card starts sticking */
      max-height: 80vh; /* Limit height to prevent it from being too large */
      overflow-y: auto; /* Add scrollbar if content is too tall */
      z-index: 1000; /* Ensure it appears above other content */
    }



    .tour-title {
      font-weight: 700;
      color: var(--text-color);
      animation: slideInFromLeft 1s ease-out;
    }

    .tour-details {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      animation: fadeIn 1.2s ease-out;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 5px;
      background-color: #f0f0f0;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .book-now-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .book-now-btn:hover {
      background-color: #f57c00;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .review-stars {
      color: #ffc107;
    }

    .description-section {
      animation: fadeIn 1.4s ease-out;
    }

    .navbar {
      animation: slideInFromLeft 0.8s ease-out;
    }
    .description{
      font-size: 15px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    /*h4{*/
    /*  font-weight: 700;*/
    /*  font-size: 18px;*/
    /*  font-family: "JetBrains Mono ExtraLight";*/
    /*}*/
    /*h2{*/
    /*  font-family: "JetBrains Mono ExtraLight";*/
    /*}*/

    /* Previous CSS remains the same */

    #mapContainer {
      height: 300px;
      width: 100%;
      border-radius: 10px;
      margin-top: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .container{
      margin-top: 6%;
    }
    .review-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .star-rating {
      color: #ffc107;
      cursor: pointer;
      font-size: 17px;
    }
    .review-input {
      border-radius: 20px;
      padding: 10px 15px;
    }
    .submit-btn {
      background-color: #ff9800;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 10px 20px;
    }
    .submit-btn:hover {
      background-color: #f57c00;
    }
    .existing-review {
      border-top: 1px solid #e0e0e0;
      padding: 15px 0;
    }
    .user-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 15px;
    }
    #reviewForm {
      margin-bottom: 20px;
    }
    .drop-zone {
      border: 2px dashed #ccc;
      border-radius: 20px;
      width: 100%;
      text-align: center;
      padding: 20px;
      transition: background-color 0.3s ease;
    }
    .drop-zone.drag-over {
      background-color: #f0f0f0;
    }
    .drop-zone-text {
      color: #888;
    }
    .drop-zone-preview {
      max-width: 200px;
      max-height: 200px;
      margin: 10px auto;
      border-radius: 10px;
    }
    .remove-image {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    /* Fixed height gallery styles */
    #tourGalleryContainer {
      margin-bottom: 40px;
    }

    .gallery-thumbnail {
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .gallery-thumbnail:hover {
      opacity: 0.9;
      transform: scale(1.01);
    }

    /* Match exact spacing to your screenshot */
    .row.g-3 {
      --bs-gutter-x: 1rem;
      --bs-gutter-y: 1rem;
    }

    /* Ensure consistent image heights */
    #tourGalleryContainer img {
      width: 100%;
      object-fit: cover;
      border-radius: 8px;
    }

    /* Style the photo count badge to match screenshot */
    .photo-count-badge {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background-color: rgba(0,0,0,0.6);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 5px;
      z-index: 2;
    }

    /* Style the show all photos button */
    #viewAllPhotos {
      white-space: nowrap;
      background-color: white;
      color: #333;
      border: none;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    #viewAllPhotos:hover {
      background-color: #f8f9fa;
      transform: scale(1.05);
    }

    /* Image loading animation */
    .gallery-thumbnail {
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>

<!-- Topbar Start -->
<div class="container-fluid bg-dark px-5 d-none d-lg-block">
  <div class="row gx-0">
    <div class="col-lg-8 text-center text-lg-start mb-2 mb-lg-0">
      <div class="d-inline-flex align-items-center" style="height: 45px;">
        <small class="me-3 text-light"><i class="fa fa-map-marker-alt me-2"></i>123 Street, New York, USA</small>
        <small class="me-3 text-light"><i class="fa fa-phone-alt me-2"></i>+012 345 6789</small>
        <small class="text-light"><i class="fa fa-envelope-open me-2"></i>info@example.com</small>
      </div>
    </div>
    <div class="col-lg-4 text-center text-lg-end">
      <div class="d-inline-flex align-items-center" style="height: 45px;">
        <a class="btn btn-sm btn-outline-light btn-sm-square rounded-circle me-2" href=""><i class="fab fa-twitter fw-normal"></i></a>
        <a class="btn btn-sm btn-outline-light btn-sm-square rounded-circle me-2" href=""><i class="fab fa-facebook-f fw-normal"></i></a>
        <a class="btn btn-sm btn-outline-light btn-sm-square rounded-circle me-2" href=""><i class="fab fa-linkedin-in fw-normal"></i></a>
        <a class="btn btn-sm btn-outline-light btn-sm-square rounded-circle me-2" href=""><i class="fab fa-instagram fw-normal"></i></a>
        <a class="btn btn-sm btn-outline-light btn-sm-square rounded-circle" href=""><i class="fab fa-youtube fw-normal"></i></a>
      </div>
    </div>
  </div>
</div>
<!-- Topbar End -->


<!-- Navbar & Hero Start -->
<div class="container-fluid position-relative p-0">
  <nav class="navbar navbar-expand-lg navbar-light px-4 px-lg-5 py-3 py-lg-0">
    <a href="" class="navbar-brand p-0">
      <h1 class="text-primary m-0"><i class="fa fa-map-marker-alt me-3"></i>Tourist</h1>
      <!-- <img src="img/logo.png" alt="Logo"> -->
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
      <span class="fa fa-bars"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <div class="navbar-nav ms-auto py-0">
        <a href="index.html" class="nav-item nav-link">Home</a>
        <a href="about.html" class="nav-item nav-link">About</a>
        <a href="service.html" class="nav-item nav-link">Services</a>
        <a href="package.html" class="nav-item nav-link">Packages</a>
        <div class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle active" data-bs-toggle="dropdown">Pages</a>
          <div class="dropdown-menu m-0">
            <a href="destination.html" class="dropdown-item">Destination</a>
            <a href="booking.html" class="dropdown-item active">Booking</a>
            <a href="team.html" class="dropdown-item">Travel Guides</a>
            <a href="testimonial.html" class="dropdown-item">Testimonial</a>
            <a href="404.html" class="dropdown-item">404 Page</a>
          </div>
        </div>
        <a href="contact.html" class="nav-item nav-link">Contact</a>
      </div>
      <a href="" class="btn btn-primary rounded-pill py-2 px-4">Register</a>
    </div>
  </nav>

  <div class="container-fluid bg-primary py-5 mb-5 hero-header">
    <div class="container py-5">
      <div class="row justify-content-center py-5">
        <div class="col-lg-10 pt-lg-5 mt-lg-5 text-center">
          <h1 class="display-3 text-white animated slideInDown">Booking</h1>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb justify-content-center">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item"><a href="#">Pages</a></li>
              <li class="breadcrumb-item text-white active" aria-current="page">Booking</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>
<button type="button" class="btn btn-primary w-100 py-3 mb-3 book-now" data-bs-toggle="modal" data-bs-target="#bookingModal">
  Book Now
</button>
<!-- Tour Gallery Container -->
<div class="container" id="tourGalleryContainer">
  <h2 class="text-center mb-4">Tour Gallery</h2>
  </div>

  <!-- View All Photos Button -->
  <div class="text-center mb-4">
    <button id="viewAllPhotos" class="btn btn-outline-primary">
      <i class="bi bi-images me-2"></i>View All Photos (5)
    </button>
  </div>
</div>

<!-- Your existing tourDetailsContainer div remains as is -->
<div class="container mt-4">
  <div id="tourDetailsContainer" class="row">
    <div class="text-center">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </div>
</div>
<div class="container mt-5">
  <div class="review-container">
    <h2 class="text-center mb-4">Tour Reviews</h2>

    <!-- Review Submission Form -->
    <form id="reviewForm" enctype="multipart/form-data">
      <div class="mb-3 d-flex align-items-center">
        <label class="me-3"><h6>Your Rating:</h6></label>
        <div id="ratingStars" class="star-rating">
          <i class="bi bi-star" data-rating="1"></i>
          <i class="bi bi-star" data-rating="2"></i>
          <i class="bi bi-star" data-rating="3"></i>
          <i class="bi bi-star" data-rating="4"></i>
          <i class="bi bi-star" data-rating="5"></i>
        </div>
        <input type="hidden" id="ratingInput" name="rating" required>
      </div>

      <!-- Name Input -->
      <div class="mb-3">
        <input type="text" id="nameInput" class="form-control review-input" placeholder="Your Name" required>
      </div>

      <!-- Comment Input -->
      <div class="mb-3">
        <textarea id="commentInput" class="form-control review-input" placeholder="Share your thoughts..." rows="3" required></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Tour Image</label>
        <div id="drag-drop-zone" class="border rounded-3 p-4 text-center" style="background-color: #f8f9fa; cursor: pointer; transition: all 0.3s ease;">
          <i class="fas fa-cloud-upload-alt text-primary fs-1 mb-3"></i>
          <p class="mb-1">Drag & Drop your image here</p>
          <p class="text-muted small mb-3">or click to browse files</p>
          <p id="selected-file-name" class="mb-0 small fw-bold" style="display: none;"></p>
          <input type="file" id="tourImage" accept="image/jpeg,image/png,image/jpg" style="display: none;">
        </div>
        <div class="form-text">Upload an image of the tour (JPEG, PNG formats only)</div>
        <div class="mt-2">
          <img id="imagePreview" src="" alt="Tour Image" style="max-width: 100%; display: none; border-radius: 5px;">
        </div>
      </div>
      <button type="submit" class="submit-btn w-100" id="submit-btn">Submit Review</button>
    </form>

    <!-- Reviews Section -->
    <div class="reviews-section mt-4">
      <h5 class="mb-3">Existing Reviews (<span id="reviewCount">0</span>)</h5>
      <div id="reviewsContainer">
        <!-- Reviews will be dynamically added here -->
      </div>
    </div>
  </div>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tourDetailsContainer = document.getElementById('tourDetailsContainer');
    const tourGalleryContainer = document.getElementById('tourGalleryContainer');
    const API_BASE_URL = 'http://localhost:8080/api/v1';

    function logError(message, error) {
      console.error('Detailed Error Log:', {
        message: message,
        fullError: error,
        apiResponseStructure: error ? Object.keys(error) : 'No error object'
      });
      tourDetailsContainer.innerHTML = `
      <div class="alert alert-danger text-center">
        <strong>Error:</strong> ${message}
        <br>Please check the console for more details.
      </div>
    `;
    }

    function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      var results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1]);
    }

    const tourId = getUrlParameter('id');
    console.log('Tour ID from URL:', tourId);

    if (!tourId) {
      logError('No tour ID provided in the URL. Please select a valid tour.');
      return;
    }

    fetch(`${API_BASE_URL}/tour/${tourId}`, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    })
      .then(response => {
        console.log('API Response Status:', response.status);
        console.log('Response Headers:', Object.fromEntries(response.headers.entries()));

        if (response.status === 404) {
          throw new Error('Tour not found. Please check the tour ID.');
        }

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return response.json();
      })
      .then(data => {
        console.log('Full API Response:', data);

        // New, more flexible data extraction
        let tour;
        if (data.code === 200 && data.data) {
          tour = data.data;
        } else if (Array.isArray(data)) {
          tour = data[0];
        } else if (data.tour) {
          tour = data.tour;
        } else {
          tour = data;
        }

        if (!tour || !tour.id) {
          throw new Error('Invalid tour data structure. Please check backend response.');
        }

        // Add mock gallery images if needed
        tour = fetchTourWithGallery(tour);

        renderTourDetails(tour);
        renderTourGallery(tour);
      })
      .catch(error => {
        console.error('Fetch Error:', error);
        logError(error.message, error);
      });

    function renderTourDetails(tour) {
      // Fallback for missing data with default values
      const safeGet = (value, defaultValue = 'Not Available') =>
        value !== undefined && value !== null ? value : defaultValue;

      // Modify location to use destination information if available
      const location = tour.name
        ? `${safeGet(tour.name, 'Unknown Location')}`
        : safeGet(tour.location, 'Unknown Location');

      // Default coordinates if not provided (using a placeholder location)
      const defaultLat = 0;
      const defaultLng = 0;
      const latitude = tour.latitude || defaultLat;
      const longitude = tour.longitude || defaultLng;

      tourDetailsContainer.innerHTML = `
      <div class="container mt-4">
        <div class="row">
          <div class="col-lg-8">


            <h2 class="tour-title mb-3">${safeGet(tour.name)}</h2>

            <div class="tour-details">
              <div class="detail-item">
                <span class="review-stars">${generateStars(4.5)}</span>
                <span>(2 Reviews)</span>
              </div>
              <div class="detail-item">
                <i class="bi bi-geo-alt"></i>
                <span>${location}</span>
              </div>
              <div class="detail-item">
                <i class="bi bi-calendar"></i>
                <span>${safeGet(tour.duration, 'N/A')} Days</span>
              </div>
              <div class="detail-item">
                <i class="bi bi-cash"></i>
                <span>$${safeGet(tour.price, 'Not Specified')}/per person</span>
              </div>
              <div class="detail-item">
                <i class="bi bi-people"></i>
                <span>Group Tour</span>
              </div>
            </div>

            <div class="description-section mt-4">
              <h4 class="mb-3">Description</h4>
              <p class="description">
                ${safeGet(tour.description)}
              </p>
            </div>

            <div id="mapContainer"></div>
          </div>


    <!-- Right Column (Booking Card) -->
    <div class="col-lg-4">
      <div class="booking-card sticky-top" style="top: 100px; z-index: 100;">
        <!-- Discount Banner -->
        <div class="position-absolute end-0 top-0 translate-middle-y" style="transform: rotate(45deg) translateX(20px);">
          <div class="bg-danger text-white px-5 py-1" style="transform: rotate(-45deg);">
            <strong>20% Off</strong>
          </div>
        </div>

        <!-- Price Section -->
        <div class="mb-4">
          <p class="mb-1 text-muted">From <span style="text-decoration: line-through;">USD ${tour.price}</span></p>
          <h2 class="mb-0">USD $${tour.price} <small class="text-muted">/Adult</small></h2>

          <!-- Rating -->
          <div class="mt-2">
            <span class="review-stars me-2">
              <i class="bi bi-star-fill text-warning"></i>
              <i class="bi bi-star-fill text-warning"></i>
              <i class="bi bi-star-fill text-warning"></i>
              <i class="bi bi-star-fill text-warning"></i>
              <i class="bi bi-star-half text-warning"></i>
            </span>
            <a href="#reviewsSection" class="text-primary">reviews</a>
          </div>
        </div>

        <!-- Benefits List -->
        <div class="mb-4">
          <div class="d-flex align-items-center mb-3">
            <i class="bi bi-check-circle-fill text-success me-2"></i>
            <span>Best Price Guarantee</span>
          </div>
          <div class="d-flex align-items-center mb-3">
            <i class="bi bi-check-circle-fill text-success me-2"></i>
            <span>The tour is fully customizable</span>
          </div>
          <div class="d-flex align-items-center mb-3">
            <i class="bi bi-check-circle-fill text-success me-2"></i>
            <span>Professional Local Guide</span>
          </div>
        </div>

        <!-- Action Buttons -->
        <button type="button" class="btn btn-primary w-100 py-3 mb-3 book-now" data-bs-toggle="modal" data-bs-target="#bookingModal">
          Book Now
        </button>

        <button type="button" class="btn btn-outline-primary w-100 py-3">
          Ask a Question
        </button>
      </div>
    </div>
  </div>
        </div>
      </div>
    `;

      // Initialize map after rendering
      initializeMap(latitude, longitude, location);
    }

    function initializeMap(lat, lng, locationName) {
      const mapContainer = document.getElementById('mapContainer');

      // If lat/lng are not provided, fetch them using Geocoding API
      if ((lat === 0 && lng === 0) || lat === null || lng === null) {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}`)
          .then(response => response.json())
          .then(data => {
            if (data.length > 0) {
              lat = parseFloat(data[0].lat);
              lng = parseFloat(data[0].lon);
              console.log(`Fetched coordinates: ${lat}, ${lng}`);
              renderMap(lat, lng, locationName);
            } else {
              mapContainer.innerHTML = `<div class="alert alert-warning">Location not found for ${locationName}</div>`;
            }
          })
          .catch(error => {
            console.error('Error fetching geolocation:', error);
            mapContainer.innerHTML = `<div class="alert alert-danger">Error fetching location data.</div>`;
          });
      } else {
        renderMap(lat, lng, locationName);
      }
    }

    // Function to render map
    function renderMap(lat, lng, locationName) {
      const map = L.map('mapContainer').setView([lat, lng], 10);

      // Add OpenStreetMap tiles
      L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; Stadia Maps, OpenMapTiles, OpenStreetMap contributors'
      }).addTo(map);

      // Add marker
      L.marker([lat, lng])
        .addTo(map)
        .bindPopup(locationName)
        .openPopup();
    }

    function generateStars(rating) {
      const fullStars = Math.floor(rating);
      const halfStar = rating % 1 >= 0.5;
      let starsHTML = '';

      for (let i = 1; i <= 5; i++) {
        if (i <= fullStars) {
          starsHTML += '<i class="bi bi-star-fill"></i>';
        } else if (i === fullStars + 1 && halfStar) {
          starsHTML += '<i class="bi bi-star-half"></i>';
        } else {
          starsHTML += '<i class="bi bi-star"></i>';
        }
      }

      return starsHTML;
    }

    function renderTourGallery(tour) {
      // Check if we have gallery images
      if (!tour.galleryImages && !tour.image) {
        // If no gallery images, don't render gallery section
        tourGalleryContainer.style.display = 'none';
        return;
      }

      // Prepare gallery images array
      let galleryImages = [];

      // Add main image if available
      if (tour.image) {
        galleryImages.push({
          src: `data:image/jpeg;base64,${tour.image}`,
          alt: `${tour.name} - Main Image`
        });
      }

      // Add additional gallery images if available
      if (tour.galleryImages && Array.isArray(tour.galleryImages)) {
        tour.galleryImages.forEach((img, index) => {
          galleryImages.push({
            src: typeof img === 'string' ? img : `data:image/jpeg;base64,${img}`,
            alt: `${tour.name} - Gallery Image ${index + 1}`
          });
        });
      }

      // If no images available, use placeholders
      if (galleryImages.length === 0) {
        // Create 4 placeholder images
        for (let i = 1; i <= 4; i++) {
          galleryImages.push({
            src: `https://via.placeholder.com/800x600?text=Tour+Image+${i}`,
            alt: `${tour.name} - Placeholder ${i}`
          });
        }
      }

      // We need at least 4 images for this layout
      while (galleryImages.length < 4) {
        galleryImages.push({
          src: `https://via.placeholder.com/800x600?text=Tour+Image+${galleryImages.length + 1}`,
          alt: `${tour.name} - Placeholder ${galleryImages.length + 1}`
        });
      }

      // Create gallery HTML - Grid Layout with increased heights
      let galleryHTML = `
    <div class="row g-3">
      <!-- Main Large Image (Left Side) - INCREASED HEIGHT -->
      <div class="col-md-6 position-relative">
        <img src="${galleryImages[0].src}" class="img-fluid w-100 h-100 rounded shadow gallery-thumbnail"
             alt="${galleryImages[0].alt}" style="object-fit: cover; min-height: 590px; max-height: 200px;">

        <!-- Photo count badge -->
        <div class="photo-count-badge">
          <i class="bi bi-camera-fill"></i> ${galleryImages.length} photos
        </div>
      </div>

      <!-- Right Side Grid -->
      <div class="col-md-6">
        <div class="row g-3">
          <!-- Top Image (Full Width) - INCREASED HEIGHT -->
          <div class="col-12">
            <img src="${galleryImages[1].src}" class="img-fluid w-100 rounded shadow gallery-thumbnail"
                 alt="${galleryImages[1].alt}" style="object-fit: cover; height: 310px;">
          </div>

          <!-- Bottom Row - Two Images Side by Side - INCREASED HEIGHT -->
          <div class="col-6">
            <img src="${galleryImages[2].src}" class="img-fluid w-100 rounded shadow gallery-thumbnail"
                 alt="${galleryImages[2].alt}" style="object-fit: cover; height: 260px;">
          </div>
          <div class="col-6 position-relative">
            <img src="${galleryImages[3].src}" class="img-fluid w-100 rounded shadow gallery-thumbnail"
                 alt="${galleryImages[3].alt}" style="object-fit: cover; height: 260px; filter: brightness(0.85);">
            <!-- "Show all photos" button overlaid on the last image -->
            <div class="position-absolute top-50 start-50 translate-middle">
              <button class="btn btn-light btn-sm rounded-pill shadow-sm px-3 py-2" id="viewAllPhotos">
                <i class="bi bi-grid me-2"></i>Show all photos
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

      // Set the HTML content
      tourGalleryContainer.innerHTML = galleryHTML;

      // Add event listener to "Show all photos" button
      const viewAllButton = document.getElementById('viewAllPhotos');
      if (viewAllButton) {
        viewAllButton.addEventListener('click', function() {
          openPhotoGalleryModal(galleryImages);
        });
      }
    }
    // If your API doesn't provide gallery images, we can simulate them
    function fetchTourWithGallery(tour) {
      // If tour doesn't have galleryImages property, add mock data
      if (!tour.galleryImages) {
        // For demonstration purposes, create mock gallery from the main image
        // In production, you would fetch this from your API
        tour.galleryImages = [
          // These URLs should be replaced with your actual gallery images
          '../img/car.jpg',
          'https://images.unsplash.com/photo-1501555088652-021faa106b9b',
          'https://images.unsplash.com/photo-1506197603052-3cc9c3a201bd',
          'https://images.unsplash.com/photo-1544735716-392fe2489ffa'
        ];
      }
      return tour;
    }

    // Review functionality
    const ratingStars = document.querySelectorAll('#ratingStars i');
    const ratingInput = document.getElementById('ratingInput');
    const reviewForm = document.getElementById('reviewForm');
    const dragDropZone = document.getElementById('drag-drop-zone');
    const fileInput = document.getElementById('tourImage');
    const imagePreview = document.getElementById('imagePreview');
    const selectedFileName = document.getElementById('selected-file-name');

    // Handle star rating selection
    ratingStars.forEach(star => {
      star.addEventListener('click', function() {
        const rating = parseInt(this.getAttribute('data-rating'));
        updateStarRating(rating);
        ratingInput.value = rating;
      });

      star.addEventListener('mouseover', function() {
        const rating = parseInt(this.getAttribute('data-rating'));
        highlightStars(rating);
      });
    });

    document.getElementById('ratingStars').addEventListener('mouseout', function() {
      const currentRating = parseInt(ratingInput.value) || 0;
      highlightStars(currentRating);
    });

    function updateStarRating(rating) {
      ratingInput.value = rating;
      highlightStars(rating);
    }

    function highlightStars(rating) {
      ratingStars.forEach(star => {
        const starRating = parseInt(star.getAttribute('data-rating'));
        if (starRating <= rating) {
          star.classList.remove('bi-star');
          star.classList.add('bi-star-fill');
        } else {
          star.classList.remove('bi-star-fill');
          star.classList.add('bi-star');
        }
      });
    }

    // Handle drag and drop file upload
    dragDropZone.addEventListener('click', () => {
      fileInput.click();
    });

    dragDropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dragDropZone.classList.add('border-primary');
    });

    dragDropZone.addEventListener('dragleave', () => {
      dragDropZone.classList.remove('border-primary');
    });

    dragDropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dragDropZone.classList.remove('border-primary');

      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFileSelect(e.dataTransfer.files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (fileInput.files.length) {
        handleFileSelect(fileInput.files[0]);
      }
    });

    function handleFileSelect(file) {
      if (file && file.type.match('image.*')) {
        selectedFileName.textContent = file.name;
        selectedFileName.style.display = 'block';

        const reader = new FileReader();
        reader.onload = function(e) {
          imagePreview.src = e.target.result;
          imagePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    // Handle review submission
    reviewForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const rating = document.getElementById('ratingInput').value;
      const name = document.getElementById('nameInput').value;
      const comment = document.getElementById('commentInput').value;

      if (!rating || !name || !comment) {
        alert('Please fill out all fields before submitting your review.');
        return;
      }

      // Here you would typically send this data to your backend API
      // For demonstration, we'll just add it to the page
      addReviewToPage({
        name: name,
        rating: rating,
        comment: comment,
        date: new Date().toLocaleDateString(),
        image: imagePreview.style.display !== 'none' ? imagePreview.src : null
      });

      // Reset form
      reviewForm.reset();
      updateStarRating(0);
      imagePreview.style.display = 'none';
      selectedFileName.style.display = 'none';
    });

    function addReviewToPage(review) {
      const reviewsContainer = document.getElementById('reviewsContainer');
      const reviewCount = document.getElementById('reviewCount');

      // Create review HTML
      const reviewHTML = `
      <div class="existing-review">
        <div class="d-flex">
          <img src="${review.image || 'https://via.placeholder.com/60x60?text=User'}"
               alt="${review.name}" class="user-avatar">
          <div>
            <h6>${review.name}</h6>
            <div class="star-rating mb-1">
              ${generateStars(review.rating)}
            </div>
            <small class="text-muted">${review.date}</small>
            <p class="mt-2">${review.comment}</p>
          </div>
        </div>
      </div>
    `;

      // Add to page
      reviewsContainer.innerHTML = reviewHTML + reviewsContainer.innerHTML;

      // Update count
      const currentCount = parseInt(reviewCount.textContent);
      reviewCount.textContent = currentCount + 1;
    }
  });
  // Add this to your existing script
  // Find all "Book Now" buttons
  const bookNowButtons = document.querySelectorAll('.book-now');

  // Add click event listener to each button
  bookNowButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      // Get the current tour ID from the URL
      const urlParams = new URLSearchParams(window.location.search);
      const tourId = "TOUR002"
      // Redirect to checkout page with the tour ID
      window.location.href = `test3.html?id=${tourId}`;
    });
  });

</script>

<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/main.js"></script>

</body>
</html>
