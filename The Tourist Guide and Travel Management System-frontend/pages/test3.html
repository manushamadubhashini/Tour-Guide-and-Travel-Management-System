<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tour Booking - Checkout</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Animate.css for animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">

  <!-- Icon Font Stylesheet -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

  <!-- Google Web Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Nunito:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #86B817;
      --secondary: #69a614;
      --light: #F1F8FF;
      --dark: #0F172B;
    }

    body {
      font-family: 'Heebo', sans-serif;
      background-color: #f8f9fa;
    }

    .text-primary {
      color: var(--primary) !important;
    }

    .bg-primary {
      background-color: var(--primary) !important;
    }

    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }

    .btn-primary:hover,
    .btn-primary:active,
    .btn-primary:focus {
      background-color: var(--secondary) !important;
      border-color: var(--secondary) !important;
    }

    .btn-outline-primary {
      color: var(--primary);
      border-color: var(--primary);
    }

    .btn-outline-primary:hover {
      background-color: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    /* Navbar styling */
    .navbar {
      transition: all 0.3s ease-in-out;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
    }

    .navbar-light .navbar-nav .nav-link {
      padding: 25px 15px;
      color: var(--dark);
      font-weight: 600;
      outline: none;
      transition: all 0.5s ease;
    }

    .navbar-light .navbar-nav .nav-link:hover,
    .navbar-light .navbar-nav .nav-link.active {
      color: var(--primary);
    }

    /* Hero header */
    .hero-header {
      background: linear-gradient(rgba(15, 23, 43, .7), rgba(15, 23, 43, .7)), url(../img/car.jpg);
      background-position: center center;
      background-repeat: no-repeat;
      background-size: cover;
      position: relative;
    }

    .hero-header::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120' preserveAspectRatio='none'%3E%3Cpath d='M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z' fill='%23ffffff' opacity='.25'%3E%3C/path%3E%3Cpath d='M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z' fill='%23ffffff' opacity='.5'%3E%3C/path%3E%3Cpath d='M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z' fill='%23ffffff'%3E%3C/path%3E%3C/svg%3E") no-repeat;
      background-size: cover;
    }

    .breadcrumb-item a {
      color: var(--light);
      text-decoration: none;
      transition: color 0.3s;
    }

    .breadcrumb-item a:hover {
      color: var(--primary);
    }

    /* Checkout section styling */
    .checkout-section {
      padding: 40px 0;
    }

    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      margin-bottom: 25px;
      transition: transform 0.3s, box-shadow 0.3s;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }

    .card-header {
      background-color: white;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding: 20px;
    }

    .card-body {
      padding: 25px;
    }

    .section-header {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .section-number {
      width: 45px;
      height: 45px;
      background-color: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
      box-shadow: 0 4px 10px rgba(134, 184, 23, 0.3);
      transition: transform 0.3s;
    }

    .card:hover .section-number {
      transform: scale(1.1) rotate(10deg);
    }

    .booking-summary {
      background-color: #f8f9fa;
      border-left: 4px solid var(--primary);
      padding: 20px;
      border-radius: 8px;
    }

    .discount-badge {
      background-color: var(--primary);
      color: white;
      padding: 3px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      margin-left: 10px;
      box-shadow: 0 2px 5px rgba(134, 184, 23, 0.2);
    }

    /* Form controls */
    .form-control, .form-select {
      border-radius: 8px;
      padding: 12px 15px;
      border: 1px solid #e1e1e1;
      transition: all 0.3s;
    }

    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(134, 184, 23, 0.25);
    }

    .btn {
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-lg {
      padding: 15px 25px;
    }

    #completeBooking {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      border: none;
      box-shadow: 0 4px 15px rgba(134, 184, 23, 0.3);
      transition: all 0.3s;
    }

    #completeBooking:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(134, 184, 23, 0.4);
    }

    /* Room selection styles */
    .room-count {
      text-align: center;
      font-weight: bold;
    }

    /* Alert styling */
    .alert {
      border-radius: 10px;
      border: none;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    .alert-success {
      background-color: rgba(134, 184, 23, 0.15);
      color: var(--secondary);
    }

    .alert-info {
      background-color: rgba(66, 138, 255, 0.15);
      color: #0070e0;
    }

    .alert-warning {
      background-color: rgba(255, 193, 7, 0.15);
      color: #d68d00;
    }

    /* Animations */
    .fadeInUp {
      animation: fadeInUp 0.6s ease forwards;
    }

    @keyframes floatAnimation {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
      100% { transform: translateY(0px); }
    }

    .float-animation {
      animation: floatAnimation 3s ease-in-out infinite;
    }

    /* Loading spinner */
    .loading-overlay {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(5px);
      transition: all 0.3s;
    }

    /* Traveler counter */
    .traveler-counter {
      background-color: #f8f9fa;
      border-radius: 10px;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
      .navbar-light .navbar-nav .nav-link {
        padding: 10px;
      }
      .card-body {
        padding: 15px;
      }
    }
  </style>
</head>
<body>

<!-- Navbar & Hero Section -->
<div class="container-fluid position-relative p-0">
  <nav class="navbar navbar-expand-lg navbar-light px-4 px-lg-5 py-3 py-lg-0">
    <a href="" class="navbar-brand p-0">
      <h1 class="text-primary m-0 animate__animated animate__fadeInLeft"><i class="fa fa-map-marker-alt me-3"></i>Tourist</h1>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
      <span class="fa fa-bars"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <div class="navbar-nav ms-auto py-0">
        <a href="index.html" class="nav-item nav-link">Home</a>
        <a href="about.html" class="nav-item nav-link">About</a>
        <a href="service.html" class="nav-item nav-link">Services</a>
        <a href="package.html" class="nav-item nav-link">Packages</a>
        <div class="nav-item dropdown">
          <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">Pages</a>
          <div class="dropdown-menu m-0">
            <a href="destination.html" class="dropdown-item">Destination</a>
            <a href="booking.html" class="dropdown-item">Booking</a>
            <a href="team.html" class="dropdown-item">Travel Guides</a>
            <a href="testimonial.html" class="dropdown-item">Testimonial</a>
            <a href="404.html" class="dropdown-item">404 Page</a>
          </div>
        </div>
        <a href="contact.html" class="nav-item nav-link">Contact</a>
      </div>
      <a href="" class="btn btn-primary rounded-pill py-2 px-4 ms-3 animate__animated animate__fadeInRight">Register</a>
    </div>
  </nav>

  <div class="container-fluid bg-primary py-5 mb-5 hero-header">
    <div class="container py-5">
      <div class="row justify-content-center py-5">
        <div class="col-lg-10 pt-lg-5 mt-lg-5 text-center">
          <h1 class="display-3 text-white mb-3 animate__animated animate__fadeInDown">Confirm & Pay</h1>
          <p class="fs-4 text-white mb-4 animate__animated animate__fadeInUp">Just a few steps away from your dream vacation</p>
          <nav aria-label="breadcrumb" class="animate__animated animate__fadeIn animate__delay-1s">
            <ol class="breadcrumb justify-content-center">
              <li class="breadcrumb-item"><a href="#">Home</a></li>
              <li class="breadcrumb-item"><a href="#">Tours</a></li>
              <li class="breadcrumb-item text-white active" aria-current="page">Checkout</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Checkout Section -->
<div class="container checkout-section">
  <div class="row">
    <!-- Left Column - Booking Form -->
    <div class="col-lg-8">
      <!-- Travellers Section -->
      <div class="card mb-4 animate__animated animate__fadeInUp">
        <div class="card-body">
          <div class="section-header">
            <div class="section-number">1</div>
            <h3 class="mb-0">Travellers</h3>
          </div>

          <div class="row align-items-center mb-3">
            <div class="col-md-6">
              <label for="numTravelers" class="form-label">No. of Travellers (Adult: 18-80)</label>
            </div>
            <div class="col-md-6 d-flex align-items-center justify-content-end">
              <button class="btn btn-outline-secondary btn-sm" id="decreaseTravelers">
                <i class="fa fa-minus"></i>
              </button>
              <input type="text" class="form-control mx-2 text-center" id="numTravelers" value="1" style="max-width: 60px;">
              <button class="btn btn-outline-secondary btn-sm" id="increaseTravelers">
                <i class="fa fa-plus"></i>
              </button>

              <div class="ms-3">
                <button class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-people-fill me-2"></i>Group Discount
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Accommodation Section -->
      <div class="card mb-4 animate__animated animate__fadeInUp animate__delay-1s">
        <div class="card-body">
          <div class="section-header">
            <div class="section-number">2</div>
            <h3 class="mb-0">Accommodation</h3>
          </div>

          <div class="alert alert-info" id="accommodationAlert">
            <i class="bi bi-info-circle-fill me-2"></i>
            Please select an accommodation option for your trip
            <span id="accommodationTravelerCount">1</span>
          </div>

          <div id="accommodationContainer">
            <!-- Accommodation options will be loaded here -->
            <div class="text-center my-4">
              <div class="spinner-border text-primary float-animation" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading accommodations...</p>
            </div>
          </div>
        </div>
      </div>
      <!-- Add this after the Accommodation Section and before the Payment Details Section -->
      <div class="card mb-4 animate__animated animate__fadeInUp animate__delay-1s">
        <div class="card-body">
          <div class="section-header">
            <div class="section-number">3</div>
            <h3 class="mb-0">Transportation</h3>
          </div>

          <div class="alert alert-info" id="transportAlert">
            <i class="bi bi-info-circle-fill me-2"></i>
            Please select a transportation option for your trip
          </div>

          <div id="transportContainer">
            <!-- Transport options will be loaded here -->
            <div class="text-center my-4">
              <div class="spinner-border text-primary float-animation" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading transportation options...</p>
            </div>
          </div>
        </div>
      </div>
      <!-- Submit Button -->
      <div class="d-grid gap-2 animate__animated animate__fadeInUp animate__delay-3s">
        <button class="btn btn-primary btn-lg" type="button" id="completeBooking">
          <i class="fa fa-lock me-2"></i>Complete Booking
        </button>
        <p class="text-center mt-2 text-muted">
          <i class="fa fa-shield-alt me-1"></i> Your payment information is secure and encrypted
        </p>
      </div>
      </div>

    <!-- Right Column - Tour Summary -->
    <div class="col-lg-4">
      <!-- Tour Details -->
      <div class="card animate__animated animate__fadeInRight">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Tour Details</h5>
          <button class="btn btn-link p-0" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetails">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>
        <div class="collapse show" id="collapseDetails">
          <div class="card-body">
            <h5 id="tourName" class="mb-3">Loading...</h5>

            <div class="row mt-3">
              <div class="col-6">
                <p class="mb-1 text-muted"><i class="far fa-clock me-2 text-primary"></i>Duration:</p>
                <p class="fw-bold" id="tourDuration">--</p>
              </div>
              <div class="col-6">
                <p class="mb-1 text-muted"><i class="far fa-calendar-alt me-2 text-primary"></i>Starts on:</p>
                <p class="fw-bold" id="tourStartDate">--</p>
              </div>
            </div>

            <div class="row">
              <div class="col-6">
                <p class="mb-1 text-muted"><i class="far fa-calendar-check me-2 text-primary"></i>Ends on:</p>
                <p class="fw-bold" id="tourEndDate">--</p>
              </div>
              <div class="col-6">
                <p class="mb-1 text-muted"><i class="fas fa-users me-2 text-primary"></i>No. of Travellers:</p>
                <p class="fw-bold" id="tourTravellers">1</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card mt-4 animate__animated animate__fadeInRight animate__delay-1s">
        <div class="card-header bg-white">
          <h5 class="mb-0">Price Details</h5>
        </div>
        <div class="card-body">
          <div id="priceBreakdown">
            <h6 class="mb-3"><i class="fas fa-user-friends me-2 text-primary"></i>Traveller(s):</h6>
            <div class="d-flex justify-content-between mb-2">
              <div>Adult: <span id="adultCount">2</span> x $<span id="adultPrice"></span> <span class="discount-badge">20% Off</span></div>
              <div>$<span id="adultTotalPrice">2400</span></div>
            </div>

            <h6 class="mt-3 mb-2"><i class="fas fa-bed me-2 text-primary"></i>Accommodation</h6>
            <div class="d-flex justify-content-between mb-2">
              <div>Single Room: <span id="singleRoomCount">2</span> x $<span id="singleRoomPrice">70</span></div>
              <div>$<span id="singleRoomTotal">140</span></div>
            </div>

            <div class="d-flex justify-content-between mb-2">
              <div>Bank Charge <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Processing and service fees"></i></div>
              <div>$<span id="bankCharge">88</span></div>
            </div>

            <hr>

            <div class="d-flex justify-content-between fw-bold">
              <div>Total:</div>
              <div>$<span id="totalPrice">2628</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Promo Code Section -->
      <div class="card mt-4 animate__animated animate__fadeInRight animate__delay-2s">
        <div class="card-body">
          <h5 class="mb-3">Have a promo code?</h5>
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Enter promo code">
            <button class="btn btn-primary" type="button">Apply</button>
          </div>
        </div>
      </div>

      <!-- Need Help -->
      <div class="card mt-4 animate__animated animate__fadeInRight animate__delay-3s">
        <div class="card-body">
          <h5 class="mb-3"><i class="fa fa-headset me-2 text-primary"></i>Need Help?</h5>
          <p class="mb-2">Our support team is available 24/7</p>
          <a href="#" class="btn btn-outline-primary w-100 mb-2">
            <i class="fa fa-phone-alt me-2"></i>Contact Support
          </a>
          <a href="#" class="btn btn-outline-secondary w-100">
            <i class="fa fa-comments me-2"></i>Live Chat
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  let tourId="";
  let accoId="";
  let transId="";
  document.addEventListener('DOMContentLoaded', function() {
    // Common functions to handle URL parameters
    function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      var results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1]);
    }

    // Constants and configurations
    const API_BASE_URL = 'http://localhost:8080/api/v1';

    // Initialize page elements
    initializeCheckoutPage();

    function initializeCheckoutPage() {

      tourId= getUrlParameter('id');
      // Load tour data first
      loadTourData();

      // Load accommodation options
      loadAccommodationOptions();

      // Setup traveler count handlers
      setupTravelerCountHandlers();


      // // Add event listener to complete booking button
      // const completeBookingBtn = document.getElementById('completeBooking');
      // if (completeBookingBtn) {
      //   completeBookingBtn.addEventListener('click', handleCompleteBooking);
      // }
    }

    function loadTourData() {
      const tourId = getUrlParameter('id');
      if (!tourId) {
        showError('No tour ID provided. Please select a tour first.');
        return;
      }

      // First try to get data from sessionStorage
      const sessionData = sessionStorage.getItem('tourData');
      if (sessionData) {
        try {
          const tourData = JSON.parse(sessionData);
          populateTourDetails(tourData);
          return;
        } catch (e) {
          console.error('Error parsing session data:', e);
        }
      }

      // If no session data, fetch from API
      fetchTourDataFromAPI(tourId);
    }

    function fetchTourDataFromAPI(tourId) {
      // Show loading indicators
      document.getElementById('tourName').textContent = "Loading...";
      document.getElementById('tourDuration').textContent = "...";
      document.getElementById('tourStartDate').textContent = "...";
      document.getElementById('tourEndDate').textContent = "...";

      fetch(`${API_BASE_URL}/tour/${tourId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          // Extract tour data based on API response format
          let tour;
          if (data.code === 200 && data.data) {
            tour = data.data;
          } else if (Array.isArray(data)) {
            tour = data[0];
          } else if (data.tour) {
            tour = data.tour;
          } else {
            tour = data;
          }

          populateTourDetails(tour);
        })
        .catch(error => {
          console.error('Error fetching tour data:', error);
          showError('Failed to load tour details. Please try again later.');

          // Use fallback data in case of error
          populateTourDetails({
            id: tourId,
            name: "Paradise Tour Package",
            duration: "7 Days",
            price: 25000,
            discount: 0.2,
            bankCharge: 42
          });
        });
    }

    function populateTourDetails(tourData) {
      // Get current date for setting the tour dates
      const currentDate = new Date();
      const startDate = new Date(currentDate);
      startDate.setDate(currentDate.getDate() + 7); // Tour starts in 7 days

      const endDate = new Date(startDate);
      const durationDays = parseInt(tourData.duration) || 7;
      endDate.setDate(startDate.getDate() + durationDays);

      // Format dates
      const formatDate = (date) => {
        const options = { day: '2-digit', month: 'short', year: 'numeric' };
        const dayName = new Intl.DateTimeFormat('en-US', { weekday: 'short' }).format(date);
        return `${date.toLocaleDateString('en-US', options)} (${dayName})`;
      };

      // Update tour details in the UI
      document.getElementById('tourName').textContent = tourData.name || "Tour Package";
      document.getElementById('tourDuration').textContent = tourData.duration || "7 Days";
      document.getElementById('tourStartDate').textContent = formatDate(startDate);
      document.getElementById('tourEndDate').textContent = formatDate(endDate);

      // Update price details
      const basePrice = parseFloat(tourData.price) || 25000;
      const discount = parseFloat(tourData.discount) || 0.2; // 20% discount
      const discountedPrice = Math.round(basePrice * (1 - discount));
      const bankCharge = parseFloat(tourData.bankCharge) || 42;

      // Set price values in the UI
      if (document.getElementById('adultPrice')) {
        document.getElementById('adultPrice').textContent = basePrice;
      }

      if (document.getElementById('bankCharge')) {
        document.getElementById('bankCharge').textContent = bankCharge;
      }

      // Initial price calculation
      updatePriceCalculation();
    }

    function loadAccommodationOptions() {
      const accommodationContainer = document.getElementById('accommodationContainer');
      if (!accommodationContainer) return;

      // Show loading indicator
      accommodationContainer.innerHTML = `
    <div class="text-center my-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading accommodations...</span>
      </div>
      <p class="mt-2">Loading accommodation options...</p>
    </div>
  `;

      // Sample accommodation data (fallback if API fails)
      const fallbackAccommodations = [
        { id: 1, name: "Grand Hotel", type: "Single", price: 25000, description: "abc" },
        { id: 2, name: "abcd Hotel", type: "Double", price: 25000, description: "abcd" },
        { id: 3, name: "abc Hotel", type: "Twin", price: 35000, description: "abcd" }
      ];

      // Fetch accommodations from API or use fallback
      fetch(`${API_BASE_URL}/accommodation/${tourId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(response => {
          // Extract accommodations - handle different response formats
          let accommodations;
          if (response.data) {
            accommodations = response.data;
          } else if (Array.isArray(response)) {
            accommodations = response;
          } else {
            accommodations = [response];
          }


          renderAccommodationOptions(accommodations);
        })
        .catch(error => {
          console.error('Error fetching accommodations:', error);
          // Use fallback data if API call fails
          renderAccommodationOptions(fallbackAccommodations);
        });
    }

    function renderAccommodationOptions(accommodations) {
      const accommodationContainer = document.getElementById('accommodationContainer');
      if (!accommodationContainer) return;

      if (accommodations.length === 0) {
        accommodationContainer.innerHTML = '<div class="alert alert-info">No accommodations available.</div>';
        return;
      }

      let html = `
    <div class="alert alert-info" id="accommodationAlert">
      <i class="bi bi-info-circle-fill me-2"></i>
      Please select accommodation for all travelers
      <span id="accommodationTravelerCount">1</span>
    </div>
  `;

      // Generate accommodation cards with unique IDs for each row
      accommodations.forEach((accommodation, index) => {
        accoId=`${accommodation.id}`
        // Create a unique ID for each accommodation
        const accommodationId = `accommodation-${index}`;
        html += `
      <div class="row border-bottom py-3" id="${accommodationId}">
        <div class="col-lg-6">
          <h5>${accommodation.name}</h5>
          <p class="text-muted mb-0">${accommodation.description || 'A comfortable room choice for your stay.'}</p>
        </div>
        <div class="col-lg-3 text-center">
          <h5>$${accommodation.price}</h5>
          <p class="text-muted mb-0">per room</p>
        </div>
        <div class="col-lg-3 d-flex justify-content-end align-items-center">
          <button class="btn btn-outline-secondary btn-sm me-2 decrease-room" data-accommodation-id="${accommodationId}">-</button>
          <input type="text" class="form-control text-center room-count"
                id="${accommodationId}-count"
                value="0"
                style="max-width: 60px;"
                data-room-type="${accommodation.type}"
                data-room-price="${accommodation.price}"
                readonly>
          <button class="btn btn-outline-secondary btn-sm ms-2 increase-room" data-accommodation-id="${accommodationId}">+</button>

          <div class="ms-3">
            <button class="btn btn-outline-primary select-room" data-accommodation-id="${accommodationId}">Select</button>
          </div>
        </div>
      </div>
    `;
      });

      // Update the DOM
      accommodationContainer.innerHTML = html;

      // Add event listeners for room selection buttons
      const decreaseButtons = document.querySelectorAll('.decrease-room');
      const increaseButtons = document.querySelectorAll('.increase-room');
      const selectButtons = document.querySelectorAll('.select-room');

      decreaseButtons.forEach(button => {
        button.addEventListener('click', function() {
          const accommodationId = this.getAttribute('data-accommodation-id');
          const inputField = document.getElementById(`${accommodationId}-count`);

          if (inputField) {
            let currentValue = parseInt(inputField.value) || 0;
            if (currentValue > 0) {
              inputField.value = currentValue - 1;
              updateAccommodationStatus();
              updatePriceCalculation();
            }
          }
        });
      });

      increaseButtons.forEach(button => {
        button.addEventListener('click', function() {
          const accommodationId = this.getAttribute('data-accommodation-id');
          const inputField = document.getElementById(`${accommodationId}-count`);
          const roomType = inputField.getAttribute('data-room-type').toLowerCase();

          if (inputField) {
            let currentValue = parseInt(inputField.value) || 0;
            let maxValue = getTotalTravelers();

            // For double or twin rooms, allow half as many rooms as travelers
            if (roomType === 'double' || roomType === 'twin') {
              maxValue = Math.ceil(maxValue / 2);
            }

            if (currentValue < maxValue) {
              inputField.value = currentValue + 1;
              updateAccommodationStatus();
              updatePriceCalculation();
            }
          }
        });
      });

      selectButtons.forEach(button => {
        button.addEventListener('click', function() {
          const accommodationId = this.getAttribute('data-accommodation-id');
          selectAccommodation(accommodationId);
        });
      });

      // Initialize accommodation status
      updateAccommodationStatus();
    }

    function selectAccommodation(accommodationId) {
      console.log(`Selecting accommodation: ${accommodationId}`); // Debug log

      // Reset all room counts to 0
      const roomCountInputs = document.querySelectorAll('.room-count');
      roomCountInputs.forEach(input => {
        input.value = 0;
      });

      // Set the selected room type based on travelers
      const travelers = getTotalTravelers();
      const roomInput = document.getElementById(`${accommodationId}-count`);

      if (roomInput) {
        const roomType = roomInput.getAttribute('data-room-type').toLowerCase();

        // For double or twin rooms, calculate how many rooms needed
        if (roomType === 'double' || roomType === 'twin') {
          roomInput.value = Math.ceil(travelers / 2);
        } else {
          roomInput.value = travelers;
        }

        // Update UI and calculations
        updateAccommodationStatus();
        updatePriceCalculation();
      } else {
        console.error(`Room input not found for accommodation: ${accommodationId}`);
      }
    }

    function updateAccommodationStatus() {
      const totalTravelers = getTotalTravelers();
      let totalCapacity = 0;

      // Calculate total capacity from selected rooms
      const roomInputs = document.querySelectorAll('.room-count');
      roomInputs.forEach(input => {
        const roomType = input.getAttribute('data-room-type').toLowerCase();
        const roomCount = parseInt(input.value) || 0;

        // Different room types have different capacities
        if (roomType === 'double' || roomType === 'twin') {
          totalCapacity += roomCount * 2;
        } else {
          totalCapacity += roomCount;
        }
      });

      // Update alert message
      const accommodationAlert = document.getElementById('accommodationAlert');
      if (accommodationAlert) {
        if (totalCapacity < totalTravelers) {
          accommodationAlert.className = 'alert alert-warning';
          accommodationAlert.innerHTML = `
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        Please select accommodation for all ${totalTravelers} travelers.
        Currently selected: capacity for ${totalCapacity} traveler${totalCapacity !== 1 ? 's' : ''}.
      `;
        } else if (totalCapacity > totalTravelers) {
          accommodationAlert.className = 'alert alert-warning';
          accommodationAlert.innerHTML = `
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        You've selected rooms with capacity for ${totalCapacity} travelers, but only have ${totalTravelers} traveler${totalTravelers !== 1 ? 's' : ''}.
      `;
        } else {
          accommodationAlert.className = 'alert alert-success';
          accommodationAlert.innerHTML = `
        <i class="bi bi-check-circle-fill me-2"></i>
        Accommodation selected for all ${totalTravelers} traveler${totalTravelers !== 1 ? 's' : ''}.
      `;
        }
      }

      // Update all instances of accommodation traveler count
      updateAllTravelerCountsInUI(totalTravelers);
    }

    function setupTravelerCountHandlers() {
      const numTravelers = document.getElementById('numTravelers');
      const decreaseBtn = document.getElementById('decreaseTravelers');
      const increaseBtn = document.getElementById('increaseTravelers');

      if (!numTravelers || !decreaseBtn || !increaseBtn) return;

      decreaseBtn.addEventListener('click', function() {
        const currentValue = parseInt(numTravelers.value);
        if (currentValue > 1) {
          numTravelers.value = currentValue - 1;
          updateAllTravelerCountsInUI(currentValue - 1);
          updateAccommodationStatus();
          updatePriceCalculation();
        }
      });

      increaseBtn.addEventListener('click', function() {
        const currentValue = parseInt(numTravelers.value);
        numTravelers.value = currentValue + 1;
        updateAllTravelerCountsInUI(currentValue + 1);
        updateAccommodationStatus();
        updatePriceCalculation();
      });

      numTravelers.addEventListener('change', function() {
        let value = parseInt(this.value);
        if (isNaN(value) || value < 1) {
          value = 1;
          this.value = 1;
        }
        updateAllTravelerCountsInUI(value);
        updateAccommodationStatus();
        updatePriceCalculation();
      });
    }

    function updateAllTravelerCountsInUI(count) {
      // Update all elements showing traveler count
      const travelerCountElements = [
        document.getElementById('accommodationTravelerCount'),
        document.getElementById('tourTravellers'),
        document.getElementById('adultCount')
      ];

      travelerCountElements.forEach(element => {
        if (element) {
          element.textContent = count;
        }
      });
    }

    function getTotalTravelers() {
      const numTravelers = document.getElementById('numTravelers');
      return parseInt(numTravelers?.value || 1);
    }

    function updatePriceCalculation() {
      const travelerCount = getTotalTravelers();
      const basePrice = parseInt(document.getElementById('adultPrice')?.textContent || 25000);
      const bankCharge = parseInt(document.getElementById('bankCharge')?.textContent || 42);

      // Calculate traveler cost
      const travelerTotal = travelerCount * basePrice;

      // Calculate accommodation cost
      let totalAccommodationPrice = 0;
      const roomInputs = document.querySelectorAll('.room-count');

      roomInputs.forEach(input => {
        const roomCount = parseInt(input.value) || 0;
        if (roomCount > 0) {
          const roomPrice = parseFloat(input.getAttribute('data-room-price') || 0);
          totalAccommodationPrice += roomCount * roomPrice;
        }
      });

      // Calculate total
      const totalPrice = travelerTotal + totalAccommodationPrice + bankCharge;

      // Update UI elements
      if (document.getElementById('adultTotalPrice')) {
        document.getElementById('adultTotalPrice').textContent = travelerTotal;
      }

      // Create accommodation breakdown HTML
      let accommodationHtml = '<h6 class="mt-3 mb-2">Accommodation</h6>';
      let hasSelectedRooms = false;

      roomInputs.forEach(input => {
        const roomCount = parseInt(input.value) || 0;
        if (roomCount > 0) {
          hasSelectedRooms = true;
          const roomType = input.getAttribute('data-room-type');
          const roomPrice = parseFloat(input.getAttribute('data-room-price') || 0);
          const roomTotal = roomCount * roomPrice;

          accommodationHtml += `
        <div class="d-flex justify-content-between mb-2">
          <div>${roomType} Room: ${roomCount} x $${roomPrice}</div>
          <div>$${roomTotal}</div>
        </div>
      `;
        }
      });

      if (!hasSelectedRooms) {
        accommodationHtml += `
      <div class="text-muted mb-2">No rooms selected</div>
    `;
      }

      // Update price breakdown
      const priceBreakdown = document.getElementById('priceBreakdown');
      if (priceBreakdown) {
        priceBreakdown.innerHTML = `
      <h6 class="mb-3">Traveller(s):</h6>
      <div class="d-flex justify-content-between mb-2">
        <div>Adult: <span id="adultCount">${travelerCount}</span> x $<span id="adultPrice">${basePrice}</span> <span class="discount-badge">20% Off</span></div>
        <div>$<span id="adultTotalPrice">${travelerTotal}</span></div>
      </div>

      ${accommodationHtml}

      <div class="d-flex justify-content-between mb-2">
        <div>Bank Charge <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Processing and service fees"></i></div>
        <div>$<span id="bankCharge">${bankCharge}</span></div>
      </div>

      <hr>

      <div class="d-flex justify-content-between fw-bold">
        <div>Total:</div>
        <div>$<span id="totalPrice">${totalPrice}</span></div>
      </div>
    `;
      }

      // Update final total price display
      if (document.getElementById('totalPrice')) {
        document.getElementById('totalPrice').textContent = totalPrice;
      }
    }

    function handleCompleteBooking() {
      // Validate payment form
      const cardName = document.getElementById('cardName')?.value;
      const cardNumber = document.getElementById('cardNumber')?.value;
      const cvv = document.getElementById('cvv')?.value;
      const expiryMonth = document.getElementById('expiryMonth')?.value;
      const expiryYear = document.getElementById('expiryYear')?.value;

      if (!cardName || !cardNumber || !cvv || expiryMonth === 'MM' || expiryYear === 'YYYY') {
        alert('Please fill in all payment details.');
        return;
      }

      // Check if accommodation is selected for all travelers
      const totalTravelers = getTotalTravelers();
      let totalCapacity = 0;

      // Calculate total capacity from selected rooms
      const roomInputs = document.querySelectorAll('.room-count');
      const selectedRooms = {};

      roomInputs.forEach(input => {
        const roomType = input.getAttribute('data-room-type').toLowerCase();
        const roomCount = parseInt(input.value) || 0;
        selectedRooms[roomType] = roomCount;

        // Different room types have different capacities
        if (roomType === 'double' || roomType === 'twin') {
          totalCapacity += roomCount * 2;
        } else {
          totalCapacity += roomCount;
        }
      });

      if (totalCapacity < totalTravelers) {
        alert(`Please select accommodation for all ${totalTravelers} travelers.`);
        return;
      }

      // Get booking data
      const totalPrice = document.getElementById('totalPrice')?.textContent || '0';
      const bookingData = {
        tourId: getUrlParameter('id'),
        travelers: totalTravelers,
        rooms: selectedRooms,
        payment: {
          cardName: cardName,
          cardNumber: cardNumber,
          cvv: cvv,
          expiryMonth: expiryMonth,
          expiryYear: expiryYear
        },
        totalAmount: totalPrice
      };

      // Show loading overlay
      const loadingOverlay = document.createElement('div');
      loadingOverlay.className = 'loading-overlay';
      loadingOverlay.style.position = 'fixed';
      loadingOverlay.style.top = '0';
      loadingOverlay.style.left = '0';
      loadingOverlay.style.width = '100%';
      loadingOverlay.style.height = '100%';
      loadingOverlay.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
      loadingOverlay.style.display = 'flex';
      loadingOverlay.style.flexDirection = 'column';
      loadingOverlay.style.justifyContent = 'center';
      loadingOverlay.style.alignItems = 'center';
      loadingOverlay.style.zIndex = '9999';

      loadingOverlay.innerHTML = `
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Processing payment...</span>
    </div>
    <p class="mt-3">Processing your booking...</p>
  `;
      document.body.appendChild(loadingOverlay);

      // Simulate API call for booking (replace with actual API call)
      setTimeout(() => {
        // Generate confirmation number
        const confirmationNumber = 'BK' + Math.floor(100000 + Math.random() * 900000);

        // Store booking details for confirmation page
        sessionStorage.setItem('bookingConfirmation', JSON.stringify({
          confirmationNumber: confirmationNumber,
          bookingData: bookingData,
          tourName: document.getElementById('tourName')?.textContent,
          startDate: document.getElementById('tourStartDate')?.textContent,
          endDate: document.getElementById('tourEndDate')?.textContent
        }));

        // Remove loading overlay
        document.body.removeChild(loadingOverlay);

        // Show success message
        alert(`Booking completed successfully! Confirmation number: ${confirmationNumber}`);

        // Redirect to confirmation page
        window.location.href = `confirmation.html?ref=${confirmationNumber}`;
      }, 2000);
    }

    function showError(message) {
      const accommodationContainer = document.getElementById('accommodationContainer');
      if (accommodationContainer) {
        accommodationContainer.innerHTML = `
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <strong>Error:</strong> ${message}
      </div>
    `;
      } else {
        alert('Error: ' + message);
      }
    }
  });
  // Transport-related functions
  function loadTransportOptions() {
    const transportContainer = document.getElementById('transportContainer');
    if (!transportContainer) return;

    // Show loading indicator
    transportContainer.innerHTML = `
    <div class="text-center my-4">
      <div class="spinner-border text-primary float-animation" role="status">
        <span class="visually-hidden">Loading transportation...</span>
      </div>
      <p class="mt-2">Loading transportation options...</p>
    </div>
  `;

    // Sample transport data (fallback if API fails)
    const fallbackTransports = [
      { id: "T001", type: "Standard Car", pricePerKM: 2, passengers: 4 },
      { id: "T002", type: "Premium SUV", pricePerKM: 3.5, passengers: 6 },
      { id: "T003", type: "Van", pricePerKM: 4, passengers: 12 },
      { id: "T004", type: "Luxury Coach", pricePerKM: 10, passengers: 20 }
    ];

    // Make sure API_BASE_URL is defined
    const API_BASE_URL = window.API_BASE_URL || '/api';

    // Fetch transport options from API or use fallback
    fetch(`http://localhost:8080/api/v1/transport/${tourId}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(response => {
        // Extract transports - handle different response formats
        let transports;
        if (response.data) {
          transports = response.data;
        } else if (Array.isArray(response)) {
          transports = response;
        } else {
          transports = [response];
        }

        renderTransportOptions(transports);
      })
      .catch(error => {
        console.error('Error fetching transportation options:', error);
        // Use fallback data if API call fails
        renderTransportOptions(fallbackTransports);
      });
  }

  function renderTransportOptions(transports) {
    const transportContainer = document.getElementById('transportContainer');
    if (!transportContainer) return;

    if (transports.length === 0) {
      transportContainer.innerHTML = '<div class="alert alert-info">No transportation options available.</div>';
      return;
    }

    let html = `
    <div class="alert alert-info" id="transportAlert">
      <i class="bi bi-info-circle-fill me-2"></i>
      Please select a transportation option for your trip
    </div>
    <p class="mb-3">Select the best transportation option based on your group size. All prices are per kilometer traveled.</p>
  `;

    // Generate transport option cards
    transports.forEach((transport, index) => {
      // Make sure we have a getTotalTravelers function or provide a fallback
      const getTotalTravelers = window.getTotalTravelers || function() { return 1; };

      // Calculate if this transport can accommodate the traveler count
      const travelers = getTotalTravelers();
      const sufficientCapacity = transport.passengers >= travelers;
      const capacityClass = sufficientCapacity ? 'text-success' : 'text-danger';
      const capacityIcon = sufficientCapacity ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill';
      const capacityMessage = sufficientCapacity ?
        `Sufficient for your group of ${travelers}` :
        `Insufficient for your group of ${travelers}`;

      // Create a unique ID for each transport option
      const transportId = `transport-${transport.id}`;

      transId=`${transport.id}`;

      html += `
      <div class="card border mb-3 position-relative" id="${transportId}">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-lg-1 text-center mb-3 mb-lg-0">
              <i class="${getTransportIcon(transport.type)} fa-2x text-primary"></i>
            </div>
            <div class="col-lg-4 mb-3 mb-lg-0">
              <h5 class="mb-1">${transport.type}</h5>
              <p class="mb-0 text-muted">Capacity: ${transport.passengers} passengers</p>
              <div class="${capacityClass} small">
                <i class="bi ${capacityIcon} me-1"></i>${capacityMessage}
              </div>
            </div>
            <div class="col-lg-3 mb-3 mb-lg-0 text-center">
              <h5>$${transport.pricePerKM.toFixed(2)}</h5>
              <p class="text-muted mb-0">per kilometer</p>
            </div>
            <div class="col-lg-4 text-lg-end">
              <p class="text-muted mb-2">Average journey: 250 km</p>
              <p class="text-primary fw-bold mb-3">
                Estimated cost: $${(transport.pricePerKM * 250).toFixed(2)}
              </p>
              <button class="btn btn-outline-primary select-transport w-100 w-lg-auto"
                data-transport-id="${transport.id}"
                data-transport-type="${transport.type}"
                data-transport-price="${transport.pricePerKM}"
                data-transport-capacity="${transport.passengers}">
                Select
              </button>
            </div>
          </div>
        </div>
        <div class="selected-badge position-absolute" style="top: 10px; right: 10px; display: none;">
          <div class="badge bg-primary p-2">
            <i class="bi bi-check-lg me-1"></i> Selected
          </div>
        </div>
      </div>
    `;
    });

    // Update the DOM
    transportContainer.innerHTML = html;

    // Add event listeners for transport selection buttons
    const selectButtons = document.querySelectorAll('.select-transport');
    selectButtons.forEach(button => {
      button.addEventListener('click', function() {
        const transportId = this.getAttribute('data-transport-id');
        const transportType = this.getAttribute('data-transport-type');
        const transportPrice = parseFloat(this.getAttribute('data-transport-price'));
        const transportCapacity = parseInt(this.getAttribute('data-transport-capacity'));

        selectTransport(transportId, transportType, transportPrice, transportCapacity);
      });
    });
  }

  function getTransportIcon(transportType) {
    // Map transport types to appropriate FontAwesome icons
    const type = transportType.toLowerCase();
    if (type.includes('car')) return 'fas fa-car';
    if (type.includes('suv')) return 'fas fa-truck';
    if (type.includes('van')) return 'fas fa-shuttle-van';
    if (type.includes('coach') || type.includes('bus')) return 'fas fa-bus';
    return 'fas fa-car'; // Default icon
  }

  function selectTransport(transportId, transportType, transportPrice, transportCapacity) {
    // Clear all previously selected transport options
    document.querySelectorAll('.selected-badge').forEach(badge => {
      badge.style.display = 'none';
    });

    // Highlight the selected transport
    const selectedTransportCard = document.getElementById(`transport-${transportId}`);
    if (selectedTransportCard) {
      const badge = selectedTransportCard.querySelector('.selected-badge');
      if (badge) badge.style.display = 'block';
    }

    // Make sure we have a getTotalTravelers function or provide a fallback
    const getTotalTravelers = window.getTotalTravelers || function() { return 1; };

    // Check if capacity is sufficient
    const travelers = getTotalTravelers();
    if (transportCapacity < travelers) {
      alert(`Warning: The selected ${transportType} has a capacity of ${transportCapacity} passengers, which is less than your group size of ${travelers}.`);
    }

    // Store the selected transport details (for form submission later)
    window.selectedTransport = {
      id: transportId,
      type: transportType,
      pricePerKM: transportPrice,
      passengers: transportCapacity
    };

    // Update the alert
    const transportAlert = document.getElementById('transportAlert');
    if (transportAlert) {
      transportAlert.className = 'alert alert-success';
      transportAlert.innerHTML = `
      <i class="bi bi-check-circle-fill me-2"></i>
      ${transportType} selected for your trip
    `;
    }

    // Update price calculation with transport costs included
    if (typeof updatePriceCalculationWithTransport === 'function') {
      updatePriceCalculationWithTransport(transportPrice);
    }
  }

  // Fixed function to update price calculation with transport
  function updatePriceCalculationWithTransport(transportPricePerKM) {
    // Check if updatePriceCalculation exists before calling it
    if (typeof updatePriceCalculation === 'function') {
      updatePriceCalculation();
    }

    // Then add transport costs
    if (transportPricePerKM) {
      const averageDistance = 250; // km
      const transportCost = transportPricePerKM * averageDistance;

      // Get the existing elements from the price breakdown
      const priceBreakdown = document.getElementById('priceBreakdown');
      const totalPriceElement = document.getElementById('totalPrice');

      if (priceBreakdown && totalPriceElement) {
        // Get current total
        const currentTotal = parseFloat(totalPriceElement.textContent) || 0;

        // Remove any existing transport cost entry
        const existingTransportDiv = Array.from(priceBreakdown.querySelectorAll('div.d-flex.justify-content-between.mb-2'))
          .find(div => div.textContent.includes('Transportation'));
        if (existingTransportDiv) {
          existingTransportDiv.remove();
        }

        // Create transport cost element
        const transportDiv = document.createElement('div');
        transportDiv.className = 'd-flex justify-content-between mb-2';
        transportDiv.innerHTML = `
        <div>Transportation (250 km x $${transportPricePerKM.toFixed(2)})</div>
        <div>$${transportCost.toFixed(2)}</div>
      `;

        // Find where to insert transport cost
        const hrElement = priceBreakdown.querySelector('hr');
        const totalDiv = priceBreakdown.querySelector('div.d-flex.justify-content-between.fw-bold');

        // Insert transport div appropriately
        if (hrElement) {
          priceBreakdown.insertBefore(transportDiv, hrElement);
        } else if (totalDiv) {
          const newHr = document.createElement('hr');
          priceBreakdown.insertBefore(transportDiv, totalDiv);
          priceBreakdown.insertBefore(newHr, totalDiv);
        } else {
          priceBreakdown.appendChild(transportDiv);
        }

        // Update total price
        const newTotal = currentTotal + transportCost;
        totalPriceElement.textContent = newTotal.toFixed(2);
      }
    }
  }

  // Add an initialization function to be called when the page loads
  function initTransport() {
    loadTransportOptions();
  }

  // Call init when the DOM is fully loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTransport);
  } else {
    // DOM already loaded, call init directly
    initTransport();
  }
  $("#completeBooking").click((e) => {
    e.preventDefault();

    const currentDate = new Date();
    const year = currentDate.getFullYear();
    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
    const day = String(currentDate.getDate()).padStart(2, '0');
    const formattedDate = `${year}/${month}/${day}`;

    const id = "BOOK" + Math.floor(1000 + Math.random() * 9000); // Generate random booking ID
    const touristId = "U8908";
    const toursId = tourId;
    const accommodationsId = accoId;
    const transportId = transId;
    const date = formattedDate;
    const totalAmount = $("#totalPrice").text();
    const noOfTravellers = $("#travelerCount").text();

    const bookingData = {
      "bookingId": id,
      "touristId": touristId,
      "tourId": toursId,
      "accommodationId": accommodationsId,
      "transportId": transportId,
      "date": date,
      "totalAmount": totalAmount,
      "noOfTravellers": noOfTravellers
    };



    showLoadingOverlay("Processing your booking...");

    $.ajax({
      url: "http://localhost:8080/api/v1/booking",
      method: "POST",
      data: JSON.stringify(bookingData),
      contentType: "application/json",
      success: (res) => {
        // Store the booking data in session storage
        sessionStorage.setItem('bookingData', JSON.stringify({
          bookingId: id,
          tourId: toursId,
          tourName: $("#tourName").text(),
          startDate: $("#tourStartDate").text(),
          travelers: noOfTravellers,
          packagePrice: $("#packagePrice").text().replace('$', '') || "0",
          accommodationPrice: $("#accommodationPrice").text().replace('$', '') || "0",
          processingFee: $("#processingFee").text().replace('$', '') || "0",
          totalAmount: $("#totalPrice").text().replace('$', '') || "0",
          customerInfo: {
            firstName: "John", // Replace with actual form data
            lastName: "Doe",
            email: "john@example.com",
            phone: "0771234567",
            address: "123 Main St",
            city: "Colombo",
            country: "Sri Lanka"
          }
        }));

        console.log("Booking created successfully:", res);

        // Show success message
        showSuccessMessage("Booking created successfully! Redirecting to payment page...");

        // Use absolute path to payment.html to ensure we're navigating correctly
        setTimeout(() => {
          window.open("payment.html", "_blank");
        }, 1500);
      },
      error: (err) => {
        console.error("Error creating booking:", err);
        hideLoadingOverlay();

        // Show error message
        showErrorMessage("There was an error processing your booking. Please try again.");
      }
    });
  });

  // Helper functions for UI feedback
  function showLoadingOverlay(message) {
    const overlay = `
    <div id="loadingOverlay" class="loading-overlay">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">${message}</p>
    </div>
  `;
    $('body').append(overlay);
  }

  function hideLoadingOverlay() {
    $('#loadingOverlay').remove();
  }

  function showSuccessMessage(message) {
    const alert = `
    <div class="alert alert-success animate__animated animate__fadeIn" id="successAlert">
      <i class="fas fa-check-circle me-2"></i>${message}
    </div>
  `;
    $('#bookingForm').prepend(alert);
  }

  function showErrorMessage(message) {
    const alert = `
    <div class="alert alert-danger animate__animated animate__fadeIn" id="errorAlert">
      <i class="fas fa-exclamation-circle me-2"></i>${message}
    </div>
  `;
    $('#bookingForm').prepend(alert);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
      $('#errorAlert').addClass('animate__fadeOut');
      setTimeout(() => $('#errorAlert').remove(), 500);
    }, 5000);
  }
</script>
</body>
</html>
